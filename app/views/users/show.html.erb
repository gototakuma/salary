<div>
  <table class="table table-bordered table-condensed user-table">
    <tr>
      <td>
        <%= link_to "←", user_path(params: {id: @user.id, first_day: @first_day.prev_month }),
                         class: "btn btn-xs btn-primary" %>
        &emsp;<%= @first_day.to_s(:year_month) %>&emsp;
        <%= link_to "→", user_path(params: {id: @user.id, first_day: @first_day.next_month }),
                         class: "btn btn-xs btn-primary" %>
      </td>
      <td>名前：<%= @user.name %></td>
      <td>基本給:<%= @user.basic_salary %>円</td>
      <td>出勤日数：<%= @workdays %></td>
      <td>扶養額:<%= @user.recharge %>万 </td>
    </tr>
  </table>
</div>

<h1>From日付からTo日付までの経過日数を計算する</h1>
 
<form id="test2" action="/" method="post" name="range">From日付：
<input id="fromYear" type="text" name="fromy" size="6" maxlength="4" /> 年 
<input id="fromMonth" type="text" name="fromm" size="4" maxlength="2" /> 月 
<input id="fromDate" type="text" name="fromd" size="4" maxlength="2" /> 日
 
To日付：
<input id="toYear" type="text" name="toy" size="6" maxlength="4" /> 年 
<input id="toMonth" type="text" name="tom" size="4" maxlength="2" /> 月 
<input id="toDate" type="text" name="tod" size="4" maxlength="2" /> 日
 
<input id="calcButton" type="submit" name="regist" value="計算" />
<input id="resetButton" type="reset" name="reset" value="リセット" />
 
</form>
<p id="returnDate"></p>

<!--クイックモーダル-->
<% @dates.each do |day| %>
  <%= fields_for"pays[]", day do |af| %>
    <% if day.worked_on == Date.today #&& day.started.nil?%>
      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal-<%=day.id%>">
      クイック入力</button>
      <div class="modal fade" id="modal-<%=day.id%>" tabindex="-1" role="dialog" aria-hidden="true" >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h1>今日のシフト時間入力</h1>
            </div>
            <div class="modal-body">
              <%= form_for(@user,url: update_pays_path(params: {id: @user.id})) do |f| %>
          
              <%= day.worked_on.to_s(:date) %>
            
              <%= f.label :started %>
              <%= af.time_field :started %>

              <%= f.label :finished %>
              <%= af.time_field :finished %>
              
              <%= af.text_field :salary , class: "sa"%>
              
              
              <%= af.check_box :nextday_box %>
            </div>
          <div class="modal-footer">
              <%= f.submit "保存", class: "btn btn-primary" %>
          </div>
              <%end%><!--form_for-->
          </div>
        </div>
      </div>
    <%end%><!--if-->
  <%end%><!--fields_for-->
<%end%><!--@dates-->
<!--クイックモーダル終了-->
<div>
  <table class="table table-bordered table-condensed table-hover" id="table-attendances">
    <thead>
      <tr>
        <th>日付</th>
        <th>曜日</th>
        <th>出勤時間</th>
        <th>退勤時間</th>
        <th>労働時間</th>
        <th>残業時間</th>
        <th>給料</th>
        <th>備考</th>
        <td>編集</td>
      </tr>
    </thead>

    <tbody>
      <% @dates.each do |day| %>
        <tr>
          <td><%= day.worked_on.to_s(:date) %></td>
          <td><%= %w{日 月 火 水 木 金 土}[day.worked_on.wday] %></td>
          <td><%= day.started.to_s(:hourmin) if day.started.present? %></td>
          <td><%= day.finished.to_s(:hourmin) if day.finished.present? %></td>
          <td>
            <!--翌日時間労働時間-->
            <% if day.started.present? && day.finished.present? && day.nextday_box== true%>
              <%= working_times_nextday(day.started, day.finished).to_f %>
              <% @total_seconds =+ @total_seconds.to_f + working_times_nextday(day.started, day.finished).to_f %>
            <!--当日労働時間-->
            <% elsif day.started.present? && day.finished.present? %>
              <%= working_times(day.started, day.finished) %>
              <% @total_seconds =+ @total_seconds.to_f + working_times(day.started, day.finished).to_f %>
            <%end%>
          </td><!--労働時間/td-->
          <td>
            <!--翌日残業時間-->
            <% if day.started.present? && day.finished.present? && working_times_nextday(day.started, day.finished).to_i > 8 && day.nextday_box== true%>
              <%= working_times_nextday_overtime(day.started, day.finished).to_f%>
              <% @secondsov =+ @secondsov.to_f + working_times_nextday_overtime(day.started, day.finished).to_f%>
            <!--当日残業時間-->
            <% elsif day.started.present? && day.finished.present? && working_times(day.started, day.finished).to_i > 8 %>
              <%= working_times_overtime(day.started, day.finished).to_f%>
              <% @secondsov =+ @secondsov.to_f +  working_times_overtime(day.started, day.finished).to_f %>
            <%end%>
          </td><!--残業時間/td-->
          <td><!--給料計算td-->
            <!--残業あり、翌日-->
            <% if day.started.present? && day.finished.present? &&  working_times_nextday(day.started, day.finished).to_i > 8 && day.nextday_box== true%>
              <%= nextday_overtime_pay(day.started,day.finished,@user.basic_salary).floor%>円
            <!--残業なし、翌日-->
            <% elsif day.started.present? && day.finished.present? &&  working_times_nextday(day.started, day.finished).to_i <= 8 &&day.nextday_box== true %>
              <%= nextday_basic_pay(day.started,day.finished,@user.basic_salary) %>円
            <!--残業なし、その日-->
            <% elsif day.started.present? && day.finished.present? && working_times(day.started, day.finished).to_i <= 8%> 
              <%=  basic_pay(day.started,day.finished,@user.basic_salary).floor %>円
            <!--残業あり、その日-->
            <% elsif day.started.present? && day.finished.present? && working_times(day.started, day.finished).to_i > 8 %>
              <%= overtime_pay(day.started,day.finished,@user.basic_salary).floor%>円
            <%end%>
             
          </td><!--給料計算/td-->
          <td></td>
          <td>
            <!--編集モーダル-->
            <%= fields_for"pays[]", day do |af| %>
              <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal-<%=day.id%>">
              編集</button>
                <div class="modal fade" id="modal-<%=day.id%>" tabindex="-1" role="dialog" aria-hidden="true" >
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                    <div class="modal-header">
                      <h1>今日のシフト時間編集</h1>
                    </div>
                    <div class="modal-body">
                      <%= form_for(@user,url: update_pays_path(params: {id: @user.id})) do |f| %>
          
                        <%= day.worked_on.to_s(:date) %>
                        
                          <%= f.label :started%>
                          <%= af.time_field :started, class: "st"%>

                        <%= f.label :finished %>
                        <%= af.time_field :finished, class: "fi" %>

                        
                        <%= af.text_field :salary , class: "sa"%>
                        <p></p>
                        <p2></p2>
                        <p3></p3>
                        
                        
                        <%= af.check_box :nextday_box %>
                    </div>
                    <div class="modal-footer">
                        <%= f.submit "保存", class: "btn btn-primary" %>
                    </div>
                      <%end%><!--form_for-->
                  </div>
                </div>
              </div>
            <!--編集モーダル終了-->
          </td>
          <td>
            <%end%><!--fields_for-->
          </td>
        </tr>
        
      <% end %><!--@dates-->
    </tbody>
    <tfoot>
      <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td><%= @total_seconds unless @total_seconds.nil? %></td>
        <td><%= @secondsov unless @secondsov.nil?  %></td>
        <td></td><!--給料合計/td-->
        <td>年間<%= @total_salary %></td>
      </tr>
    </tfoot>
  </table>
</div>



<script>
$(function(){
  $(".st").change(function() {
   var one_sec = 1000 // 1秒
    , one_min = one_sec * 60 // 1分
    , one_hour = one_min * 60 // 1時間
    , var dt = new Date()
    , datetime_a = '2000-01-01 08:45:50'
    , datetime_b = '2000-01-01 16:33:30';
    datetime_a = datetime_a.replace(/-/g, '/');
    datetime_b = datetime_b.replace(/-/g, '/');
 
    var diff = Date.parse(datetime_b) - Date.parse(datetime_a)
    , diff_h = Math.floor(diff / one_hour) // 時間
    , diff_m = Math.floor(diff % one_hour / one_min) // 分
    , diff_s = Math.floor(diff % one_min / one_sec); // 秒
    var ans = (diff_h + '時間' + diff_m + '分' + diff_s + '秒');
   $(".sa").val(ans);
  });
});


$(function() {
 $('#toDate').change(function(e) {
 e.preventDefault(); // hrefが無効になり、画面遷移が行わない
 var fromy = $('#fromYear').val();
 var fromm = $('#fromMonth').val();
 var fromd = $('#fromDate').val();
 if (fromy !== "" && fromm !== "" && fromd !== "") {
 var from = Date.parse(fromy+"/"+fromm+"/"+fromd); // From日付
 }
 
 var toy = $('#toYear').val();
 var tom = $('#toMonth').val();
 var tod = $('#toDate').val();
 if (toy !== "" && tom !== "" && tod !== "") {
 var to = Date.parse(toy+"/"+tom+"/"+tod); // To日付
 }
 
 if (from !== '' && to !== '') {
 var ans = (to - from)/1000/60/60/24; // 日数計算（単位がミリ秒���ので日単位に変換）
 returnDate = Math.floor(ans); // 小数点以下を切り捨て
 
 if (isNaN(returnDate) || returnDate == 0) { // NaN(Not a Number)を出さないように
 var returnDate = 0;
 } else {
 $('#returnDate').text(returnDate+"日経過");
 }
 } 
 });
 
 // リセット
 $('#resetButton').click(function(){
 $('#returnDate').text("");
 });
});
</script>


<!--全部の月のレコード拾ってくる。-->
<!--年間単位ででの計算-->
<!--month.each ネスト(給料)-->
<!--whereで今年分の給料を拾ってくる(合計させる)-->
<!--給料結果をカラムに入れる。新規作成必要あり-->
